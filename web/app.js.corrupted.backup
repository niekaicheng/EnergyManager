// Energy Manager Web Application
// This is the frontend JavaScript that will communicate with a Python backend API

// State management
let currentPage = 'dashboard';
let goalsCache = [];
let eventsCache = [];

// Initialize the app
document.addEventListener('DOMContentLoaded', () => {
    initializeNavigation();
    initializeApp();
});

// Navigation
function initializeNavigation() {
    const navItems = document.querySelectorAll('.nav-item');

    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const page = item.dataset.page;
            navigateToPage(page);
        });
    });
}

function navigateToPage(page) {
    // Update navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-page="${page}"]`).classList.add('active');

    // Update page content
    document.querySelectorAll('.page').forEach(p => {
        p.classList.remove('active');
    });
    document.getElementById(`${page}-page`).classList.add('active');

    currentPage = page;

    // Load page-specific data
    loadPageData(page);
}

async function loadPageData(page) {
    switch (page) {
        case 'dashboard':
            await loadDashboard();
            break;
        case 'goals':
            await loadGoals();
            break;
        case 'journal':
            await loadJournal(3);
            break;
        case 'trends':
            await loadTrends(14);
            break;
        case 'health':
            await loadHealthMetrics();
            break;
        case 'plan':
            await loadPlan();
            break;
    }
}

// Initialize app with mock data (replace with actual API calls)
async function initializeApp() {
    await loadDashboard();
}

// Dashboard
async function loadDashboard() {
    try {
        // In a real implementation, these would be API calls
        const todayEvents = await fetchTodayEvents();
        const goals = await fetchGoals();
        const healthData = await fetchTodayHealth();

        updateDashboardStats(todayEvents, goals, healthData);
        updateEnergyChart(7);
        updateBalanceChart(7);
        updateRecentActivity(todayEvents);
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

function updateDashboardStats(events, goals, health) {
    // Safety check for health object
    health = health || {};

    // Energy Balance
    const energyBalance = events.reduce((sum, e) => sum + (e.energy_cost || 0), 0);
    const balanceEl = document.getElementById('energy-balance');
    if (balanceEl) {
        balanceEl.textContent = `${energyBalance > 0 ? '+' : ''}${energyBalance}`;
        balanceEl.style.color = energyBalance >= 0 ? 'var(--success)' : 'var(--error)';
    }

    // Total time logged
    const totalMinutes = events.reduce((sum, e) => sum + (e.duration_minutes || 0), 0);
    const timeEl = document.getElementById('time-logged');
    if (timeEl) {
        timeEl.textContent = `${(totalMinutes / 60).toFixed(1)}h`;
    }
    const eventsEl = document.getElementById('time-events');
    if (eventsEl && eventsEl.querySelector('span')) {
        eventsEl.querySelector('span').textContent = `${events.length} events`;
    }

    // Active goals
    const activeGoals = goals.filter(g => g.is_active).length;
    const goalsEl = document.getElementById('active-goals');
    if (goalsEl) {
        goalsEl.textContent = activeGoals;
    }

    // Sleep score
    const sleepScore = health.sleep_score || 0;
    const sleepScoreEl = document.getElementById('sleep-score');
    if (sleepScoreEl) {
        sleepScoreEl.textContent = sleepScore || '--';
        if (sleepScore >= 75) {
            sleepScoreEl.style.color = 'var(--success)';
        } else if (sleepScore >= 60) {
            sleepScoreEl.style.color = 'var(--warning)';
        } else if (sleepScore > 0) {
            sleepScoreEl.style.color = 'var(--error)';
        }
    }

    const sleepHours = (health.sleep_total_min || 0) / 60;
    const sleepDurEl = document.getElementById('sleep-duration');
    if (sleepDurEl && sleepDurEl.querySelector('span')) {
        sleepDurEl.querySelector('span').textContent = sleepHours > 0 ? `${sleepHours.toFixed(1)} hours` : '--';
    }
}

function updateRecentActivity(events) {
    const container = document.getElementById('recent-activity');

    if (events.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No events logged today</p></div>';
        return;
    }

    container.innerHTML = events.slice(0, 5).map(event => `
        <div class="activity-item">
            <div class="activity-time">${formatTime(event.timestamp_start)}</div>
            <div class="activity-state ${event.key_state.toLowerCase().replace(' ', '-')}">${event.key_state}</div>
            <div class="activity-details">
                <div class="activity-name">${event.activity}</div>
                <div class="activity-meta">
                    ${event.duration_minutes} minutes
                    ${event.goal_name ? `• ${event.goal_name}` : ''}
                </div>
            </div>
            ${event.energy_cost ? `
                <div class="activity-cost ${event.energy_cost >= 0 ? 'positive' : 'negative'}">
                    ${event.energy_cost >= 0 ? '+' : ''}${event.energy_cost}
                </div>
            ` : ''}
        </div>
    `).join('');
}

// Goals Management
async function loadGoals() {
    try {
        const goals = await fetchGoals();
        goalsCache = goals;
        displayGoals(goals);
    } catch (error) {
        console.error('Error loading goals:', error);
    }
}

function displayGoals(goals) {
    const container = document.getElementById('goals-list');

    if (goals.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <h4>No goals yet</h4>
            </div>
            <div class="goal-cost">
                <span class="goal-cost-label">Energy Cost:</span>
                <span class="goal-cost-value ${goal.energy_cost >= 0 ? 'positive' : 'negative'}">
                    ${goal.energy_cost >= 0 ? '+' : ''}${goal.energy_cost}
                </span>
            </div>
            <div class="goal-stats">
                <div class="goal-stat">
                    <div class="goal-stat-value">${goal.event_count || 0}</div>
                    <div class="goal-stat-label">Events</div>
                </div>
                <div class="goal-stat">
                    <div class="goal-stat-value">${goal.total_hours?.toFixed(1) || '0.0'}h</div>
                    <div class="goal-stat-label">Total Time</div>
                </div>

        const goalData = {
            goal_name: document.getElementById('goal-name').value,
            priority_level: parseInt(document.getElementById('goal-priority').value),
            energy_cost: parseInt(document.getElementById('goal-cost').value)
        };

        try {
            await createGoal(goalData);
            closeModal('add-goal-modal');
            document.getElementById('add-goal-form').reset();
            await loadGoals();
            showNotification('Goal added successfully!', 'success');
        } catch (error) {
            showNotification('Error adding goal: ' + error.message, 'error');
        }
    }

    function editGoal(goalId) {
        const goal = goalsCache.find(g => g.goal_id === goalId);
        if (!goal) return;

        // Populate modal with current goal data
        document.getElementById('goal-name').value = goal.goal_name;
        document.getElementById('goal-priority').value = goal.priority_level;
        document.getElementById('goal-cost').value = goal.energy_cost;

        // Change modal title
        const modal = document.getElementById('add-goal-modal');
        const modalTitle = modal.querySelector('h3');
        modalTitle.textContent = 'Edit Goal';

        // Change form submit to update instead of add
        const form = document.getElementById('add-goal-form');
        form.onsubmit = async (e) => {
            e.preventDefault();

            const goalData = {
                goal_name: document.getElementById('goal-name').value,
                priority_level: parseInt(document.getElementById('goal-priority').value),
                energy_cost: parseInt(document.getElementById('goal-cost').value)
            };

            try {
                await updateGoal(goalId, goalData);
                closeModal('add-goal-modal');
                form.reset();
                modalTitle.textContent = 'Add New Goal';
                form.onsubmit = addGoal; // Reset to add function
                await loadGoals();
                showNotification('Goal updated successfully!', 'success');
            } catch (error) {
                showNotification('Error updating goal: ' + error.message, 'error');
            }
        };

        modal.classList.add('active');
    }

    async function archiveGoal(goalId) {
        if (!confirm('Are you sure you want to archive this goal?')) return;

        try {
            await archiveGoalById(goalId);
            await loadGoals();
            showNotification('Goal archived successfully!', 'success');
        } catch (error) {
            showNotification('Error archiving goal: ' + error.message, 'error');
        }
    }

    // Journal
    async function loadJournal(days = 90) {
        if (typeof renderJournal === 'function') {
            await renderJournal(days);
        } else {
            console.error('renderJournal function not found. Is calendar.js loaded?');
        }
    }

    async function fetchEvents(days = 7) {
        try {
            // Calculate start date
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);
            const startDateStr = startDate.toISOString().split('T')[0];

            const response = await fetch(`${ API_BASE } /api/events ? start_date = ${ startDateStr } `);
            if (!response.ok) throw new Error('Failed to fetch events');
            return await response.json();
        } catch (error) {
            console.error('Error fetching events:', error);
            return [];
        }
    }

    function showLogEventModal() {
        // Populate goals dropdown
        const goalSelect = document.getElementById('event-goal');
        goalSelect.innerHTML = '<option value="">None</option>' +
            goalsCache.map(g => `< option value = "${g.goal_id}" > ${ g.goal_name }</option > `).join('');

        document.getElementById('log-event-modal').classList.add('active');
    }

    async function logEvent(event) {
        event.preventDefault();

        const eventData = {
            activity: document.getElementById('event-activity').value,
            duration_minutes: parseInt(document.getElementById('event-duration').value),
            goal_id: document.getElementById('event-goal').value || null,
            key_state: document.getElementById('event-state').value,
            physical_score: parseInt(document.getElementById('event-physical').value),
            mental_score: parseInt(document.getElementById('event-mental').value),
            emotional_score: parseInt(document.getElementById('event-emotional').value),
            notes: document.getElementById('event-notes').value,
            timestamp_start: new Date().toISOString()
        };

        try {
            await createEvent(eventData);
            closeModal('log-event-modal');
            document.getElementById('log-event-form').reset();
            if (currentPage === 'journal') {
                await loadJournal(3);
            }
            showNotification('Event logged successfully!', 'success');
        } catch (error) {
            showNotification('Error logging event: ' + error.message, 'error');
        }
    }

    // Trends
    async function loadTrends(days) {
        try {
            const trends = await fetchTrends(days);
            displayTrends(trends);
            updateTrendsCharts(trends);
        } catch (error) {
            console.error('Error loading trends:', error);
        }
    }

    function displayTrends(trends) {
        const container = document.getElementById('trend-table');

        if (trends.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No trend data available</p></div>';
            return;
        }

        container.innerHTML = `
            < div class="table-container" >
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Sleep Score</th>
                            <th>RHR</th>
                            <th>Stress</th>
                            <th>Steps</th>
                            <th>Events</th>
                            <th>Total Time</th>
                            <th>Energy Net</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trends.map(day => {
                            const sleepColor = (day.sleep_score >= 75) ? 'var(--success)' : (day.sleep_score >= 60) ? 'var(--warning)' : 'var(--error)';
                            return `
                        <tr>
                            <td><strong>${formatDate(day.date)}</strong></td>
                            <td style="color: ${day.sleep_score ? sleepColor : 'var(--text-secondary)'}">
                                ${day.sleep_score || '-'}
                            </td>
                            <td>${day.rhr_avg || '-'}</td>
                            <td>${day.stress_avg || '-'}</td>
                            <td>${day.steps_total || '-'}</td>
                            <td>${day.event_count || 0}</td>
                            <td>${day.total_hours?.toFixed(1) || '0.0'}h</td>
                            <td style="color: ${(day.energy_net || 0) >= 0 ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                                ${(day.energy_net || 0) >= 0 ? '+' : ''}${day.energy_net || 0}
                            </td>
                        </tr>
                    `}).join('')}
                    </tbody>
                </table>
        </div >
            `;
    }

    function updateTrendsCharts(trends) {
        const reversedTrends = [...trends].reverse();
        const labels = reversedTrends.map(t => {
            const date = new Date(t.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        // Energy Balance Chart
        const balanceCtx = document.getElementById('trends-balance-chart');
        if (balanceCtx) {
            if (window.trendsBalanceChartInstance) {
                window.trendsBalanceChartInstance.destroy();
            }

            window.trendsBalanceChartInstance = new Chart(balanceCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Energy Balance',
                        data: reversedTrends.map(t => t.energy_net || 0),
                        borderColor: 'rgba(99, 102, 241, 1)',
                        backgroundColor: function (context) {
                            const value = context.raw;
                            return value >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                        },
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: function (context) {
                            const value = context.raw;
                            return value >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)';
                        },
                        pointBorderColor: '#fff',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.9)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(99, 102, 241, 0.3)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        // Hours Chart
        const hoursCtx = document.getElementById('trends-hours-chart');
        if (hoursCtx) {
            if (window.trendsHoursChartInstance) {
                window.trendsHoursChartInstance.destroy();
            }

            window.trendsHoursChartInstance = new Chart(hoursCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Activity Hours',
                        data: reversedTrends.map(t => t.total_hours || 0),
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.9)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(139, 92, 246, 0.3)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }
    }

    // Health Metrics
    async function loadHealthMetrics(dateString = null) {
        try {
            const healthData = await fetchTodayHealth(dateString);

            if (healthData) {
                updateHealthMetricsDisplay(healthData);
            } else {
                // Reset metrics if no data
                document.getElementById('metric-sleep-score').textContent = '--';
                document.getElementById('metric-sleep-hours').textContent = '-- hours';
                document.getElementById('metric-rhr').textContent = '--';
                document.getElementById('metric-hr-range').textContent = 'Range: --';
                document.getElementById('metric-stress').textContent = '--';
                document.getElementById('metric-stress-status').textContent = '--';
                document.getElementById('metric-steps').textContent = '--';
            }

            updateHealthChart();

            // Load Weekly Report
            const reportData = await fetchReport();
            renderWeeklyReport(reportData);

        } catch (error) {
            console.error('Error loading health metrics:', error);
        }
    }

    function updateHealthMetricsDisplay(health) {
        document.getElementById('metric-sleep-score').textContent = health.sleep_score || '--';
        document.getElementById('metric-sleep-hours').textContent =
            health.sleep_total_min ? `${ (health.sleep_total_min / 60).toFixed(1) } hours` : '-- hours';

        document.getElementById('metric-rhr').textContent = health.rhr_avg || '--';
        document.getElementById('metric-hr-range').textContent =
            health.hr_min && health.hr_max ? `Range: ${ health.hr_min } -${ health.hr_max } ` : 'Range: --';

        document.getElementById('metric-stress').textContent = health.stress_avg || '--';
        const stressLevel = health.stress_avg;
        let stressStatus = 'Unknown';
        if (stressLevel < 25) stressStatus = 'Low';
        else if (stressLevel < 50) stressStatus = 'Normal';
        else if (stressLevel < 75) stressStatus = 'Elevated';
        else stressStatus = 'High';
        document.getElementById('metric-stress-status').textContent = stressStatus;

        document.getElementById('metric-steps').textContent = health.steps_total || '--';
    }

    function renderWeeklyReport(data) {
        const container = document.getElementById('weekly-report-content');
        if (!container) return;

        if (!data || data.error) {
            container.innerHTML = `< p class="text-muted" > Unable to load report: ${ data?.error || 'Unknown error' }</p > `;
            return;
        }

        let html = `< div class="report-grid" style = "display: grid; gap: 20px;" > `;

        // 1. Time Investment
        if (data.goal_stats && data.goal_stats.length > 0) {
            html += `
            < div class="report-section-item" >
            <h4 style="margin-bottom: 10px; color: var(--text-primary);">Time Investment (${data.total_duration_hours.toFixed(1)}h)</h4>
            <ul style="list-style: none; padding: 0;">
                ${data.goal_stats.map(stat => {
                let color = 'var(--text-secondary)';
                if (stat.group.includes('P1')) color = 'var(--success)';
                if (stat.group.includes('P3')) color = 'var(--warning)';
                return `<li style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${stat.group}</span>
                        <span style="color: ${color}; font-weight: 500;">${stat.hours.toFixed(1)}h</span>
                    </li>`;
            }).join('')}
            </ul>
        </div > `;
        }

        // 2. Insights
        if (data.insights) {
            html += `< div class="report-section-item" >
            <h4 style="margin-bottom: 10px; color: var(--text-primary);">Strategic Insights</h4>`;

            if (data.insights.internal_friction && data.insights.internal_friction.length > 0) {
                html += `< div style = "margin-bottom: 10px;" >
                <strong style="color: var(--warning); font-size: 0.9em;">⚠️ Internal Friction Sources:</strong>
                <ul style="font-size: 0.9em; color: var(--text-secondary); padding-left: 20px; margin-top: 5px;">
                    ${data.insights.internal_friction.map(i => `<li>${i.activity} (${i.value} min)</li>`).join('')}
                </ul>
            </div > `;
            }

            if (data.insights.abundance && data.insights.abundance.length > 0) {
                html += `< div >
                <strong style="color: var(--success); font-size: 0.9em;">✨ Abundance Generators:</strong>
                <ul style="font-size: 0.9em; color: var(--text-secondary); padding-left: 20px; margin-top: 5px;">
                    ${data.insights.abundance.map(i => `<li>${i.activity}</li>`).join('')}
                </ul>
            </div > `;
            }

            html += `</div > `;
        }

        html += `</div > `;
        container.innerHTML = html;
    }

    async function loadPlan() {
        const container = document.getElementById('plan-content');
        container.innerHTML = '<p class="text-muted">Generating optimized plan...</p>';

        try {
            const data = await fetchPlan();

            if (data.error) {
                container.innerHTML = `< div class="alert alert-error" > ${ data.error }</div > `;
                return;
            }

            let html = `
            < div class="plan-overview" style = "display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;" >
            <div class="card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border: 1px solid rgba(99, 102, 241, 0.2);">
                <h3 style="color: var(--primary); margin-bottom: 5px;">${data.budget.total}</h3>
                <p class="text-muted" style="font-size: 0.9em;">Daily Energy Budget</p>
                <div style="margin-top: 10px; font-size: 0.8em; color: var(--text-secondary);">
                    <div>Sleep: ${data.budget.sleep_hours.toFixed(1)}h</div>
                    <div>RHR: ${data.budget.rhr} (Base: ${data.budget.rhr_baseline})</div>
                </div>
            </div>
            
            <div class="card">
                <h4 style="margin-bottom: 10px;">Health Recommendations</h4>
                <div style="font-size: 0.9em;">
                    <div style="margin-bottom: 8px;">
                        <strong style="color: var(--text-primary);">Sleep:</strong>
                        <span style="color: var(--text-secondary);">${data.recommendations.sleep}</span>
                    </div>
                    <div>
                        <strong style="color: var(--text-primary);">Exercise:</strong>
                        <span style="color: var(--text-secondary);">${data.recommendations.exercise}</span>
                    </div>
                </div>
            </div>
        </div >

        <h3 style="margin-bottom: 20px;">Recommended Action Plan</h3>
        <div class="plan-list" style="display: flex; flex-direction: column; gap: 15px;">
        `;

            if (data.plan.length === 0) {
                html += `<p class="text-muted">No actions recommended. Try adding more goals or recovering energy.</p>`;
            } else {
                data.plan.forEach(item => {
                    const isPositive = item.cost > 0;
                    const costColor = isPositive ? 'var(--success)' : 'var(--error)';
                    const costSign = isPositive ? '+' : '';

                    html += `
                <div class="card plan-item" style="display: flex; align-items: center; gap: 15px; border-left: 4px solid ${item.priority === 1 ? 'var(--primary)' : 'var(--text-secondary)'};">
                    <div class="plan-order" style="background: var(--bg-secondary); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        ${item.order}
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <h4 style="margin: 0;">${item.goal}</h4>
                            <span style="font-size: 0.8em; padding: 2px 8px; border-radius: 10px; background: var(--bg-secondary);">P${item.priority}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                            <span style="color: ${costColor}; font-weight: 500;">${costSign}${item.cost} Energy</span>
                            <span class="text-muted">Budget after: ${item.remaining_budget}</span>
                        </div>
                    </div>
                </div>`;
                });
            }

            html += `</div>
        <div style="margin-top: 20px; text-align: center; color: var(--text-secondary); font-size: 0.9em;">
            Remaining Budget: <strong>${data.remaining_budget_final}</strong> (Buffer for unexpected tasks)
        </div>`;

            container.innerHTML = html;

        } catch (error) {
            console.error('Error loading plan:', error);
            container.innerHTML = '<p class="error">Failed to load plan.</p>';
        }
    }

    // Charts
    async function updateEnergyChart(days) {
        const ctx = document.getElementById('energy-chart');
        if (!ctx) return;

        // Fetch real data from API
        const states = await fetchEnergyStates(days);

        const labels = Object.keys(states);
        const data = Object.values(states);

        const chartData = {
            labels: labels.length > 0 ? labels : ['Consumption', 'Internal Friction', 'Growth', 'Abundance', 'Routine'],
            datasets: [{
                data: data.length > 0 ? data : [0, 0, 0, 0, 0],
                backgroundColor: [
                    'rgba(6, 182, 212, 0.8)',
                    'rgba(234, 179, 8, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(100, 116, 139, 0.8)'
                ],
                borderWidth: 0
            }]
        };

        // Destroy existing chart if it exists
        if (window.energyChartInstance) {
            window.energyChartInstance.destroy();
        }

        window.energyChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#cbd5e1',
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });
    }

    async function updateBalanceChart(days) {
        const ctx = document.getElementById('balance-chart');
        if (!ctx) return;

        // Fetch real data from API
        const balance = await fetchEnergyBalance(days);

        const labels = balance.map(b => {
            const date = new Date(b.date);
            return date.toLocaleDateString('en-US', { weekday: 'short' });
        });
        const data = balance.map(b => b.balance);

        const chartData = {
            labels: labels.length > 0 ? labels : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Energy Balance',
                data: data.length > 0 ? data : [0, 0, 0, 0, 0, 0, 0],
                borderColor: 'rgba(99, 102, 241, 1)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        };

        // Destroy existing chart if it exists
        if (window.balanceChartInstance) {
            window.balanceChartInstance.destroy();
        }

        window.balanceChartInstance = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    }
                }
            }
        });
    }

    function updateHealthChart() {
        const ctx = document.getElementById('health-chart');
        if (!ctx) return;

        const metric = document.getElementById('health-metric-select').value;
        const days = parseInt(document.getElementById('health-days-select').value);

        // Mock data - replace with actual API call
        const data = {
            labels: Array.from({ length: days }, (_, i) => `Day ${ i + 1 } `),
            datasets: [{
                label: metric,
                data: Array.from({ length: days }, () => Math.floor(Math.random() * 40) + 60),
                borderColor: 'rgba(99, 102, 241, 1)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        };

        // Destroy existing chart if it exists
        if (window.healthChartInstance) {
            window.healthChartInstance.destroy();
        }

        window.healthChartInstance = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#cbd5e1'
                        }
                    }
                },
                scales: {
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    }
                }
            }
        });
    }

    // Modal Management
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    // Click outside modal to close
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('active');
        }
    });

    // Utility Functions
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        const options = { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' };
        return date.toLocaleDateString('en-US', options);
    }

    function formatTime(dateTimeStr) {
        const date = new Date(dateTimeStr);
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function groupEventsByDate(events) {
        return events.reduce((groups, event) => {
            const date = event.timestamp_start.split('T')[0];
            if (!groups[date]) groups[date] = [];
            groups[date].push(event);
            return groups;
        }, {});
    }

    function showNotification(message, type = 'info') {
        // Simple notification - could be enhanced with a library
        alert(message);
    }

    // API Configuration
    const API_BASE = window.location.origin;

    // API Functions
    async function fetchGoals() {
        try {
            const response = await fetch(`${ API_BASE } /api/goals`);
            if (!response.ok) throw new Error('Failed to fetch goals');
            return await response.json();
        } catch (error) {
            console.error('Error fetching goals:', error);
            return [];
        }
    }

    // Fetch today's events (or for specific date)
    async function fetchTodayEvents(dateString = null) {
        try {
            let url = `${ API_BASE } /api/events / today`;

            if (dateString) {
                url += `? date = ${ dateString } `;
            } else {
                // Default to yesterday if no date provided (legacy behavior or initial load)
                url += `? offset_days = 1`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch events');
            return await response.json();
        } catch (error) {
            console.error('Error fetching events:', error);
            return [];
        }
    }

    // Fetch today's health metrics (or for specific date)
    async function fetchTodayHealth(dateString = null) {
        try {
            let url = `${ API_BASE } /api/health / today`;

            if (dateString) {
                url += `? date = ${ dateString } `;
            } else {
                // Default to yesterday if no date provided
                url += `? offset_days = 1`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch health metrics');
            return await response.json();
        } catch (error) {
            console.error('Error fetching health metrics:', error);
            return null;
        }
    }

    // Initialize date pickers
    function initializeDatePickers() {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const dateStr = yesterday.toISOString().split('T')[0];

        const dashboardPicker = document.getElementById('dashboard-date-picker');
        if (dashboardPicker) {
            dashboardPicker.value = dateStr;
            dashboardPicker.addEventListener('change', (e) => {
                loadDashboard(e.target.value);
            });
        }

        const healthPicker = document.getElementById('health-date-picker');
        if (healthPicker) {
            healthPicker.value = dateStr;
            healthPicker.addEventListener('change', (e) => {
                loadHealthMetrics(e.target.value);
            });
        }
    }

    // Refresh functions
    function refreshDashboard() {
        const datePicker = document.getElementById('dashboard-date-picker');
        const date = datePicker ? datePicker.value : null;
        loadDashboard(date);
    }

    function refreshHealth() {
        const datePicker = document.getElementById('health-date-picker');
        const date = datePicker ? datePicker.value : null;
        loadHealthMetrics(date);
    }

    async function fetchEnergyStates(days) {
        try {
            const response = await fetch(`${ API_BASE } /api/stats / energy - states ? days = ${ days } `);
            if (!response.ok) throw new Error('Failed to fetch energy states');
            return await response.json();
        } catch (error) {
            console.error('Error fetching energy states:', error);
            return {};
        }
    }

    async function fetchReport() {
        try {
            const response = await fetch(`${ API_BASE } /api/report`);
            if (!response.ok) throw new Error('Failed to fetch report');
            return await response.json();
        } catch (error) {
            console.error('Error fetching report:', error);
            return null;
        }
    }

    async function fetchTrends(days) {
        try {
            const response = await fetch(`${ API_BASE } /api/trends ? days = ${ days } `);
            if (!response.ok) throw new Error('Failed to fetch trends');
            return await response.json();
        } catch (error) {
            console.error('Error fetching trends:', error);
            return [];
        }
    }

    async function fetchPlan() {
        try {
            const response = await fetch(`${ API_BASE } /api/plan`);
            if (!response.ok) throw new Error('Failed to fetch plan');
            return await response.json();
        } catch (error) {
            console.error('Error fetching plan:', error);
            return { error: 'Failed to fetch plan' };
        }
    }

    async function fetchEnergyBalance(days) {
        try {
            const response = await fetch(`${ API_BASE } /api/stats / balance ? days = ${ days } `);
            if (!response.ok) throw new Error('Failed to fetch energy balance');
            return await response.json();
        } catch (error) {
            console.error('Error fetching energy balance:', error);
            return [];
        }
    }

    async function createGoal(goalData) {
        try {
            const response = await fetch(`${ API_BASE } /api/goals`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(goalData)
            });
            if (!response.ok) throw new Error('Failed to create goal');
            return await response.json();
        } catch (error) {
            console.error('Error creating goal:', error);
            throw error;
        }
    }

    async function updateGoal(goalId, goalData) {
        try {
            const response = await fetch(`${ API_BASE } /api/goals / ${ goalId } `, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(goalData)
            });
            if (!response.ok) throw new Error('Failed to update goal');
            return await response.json();
        } catch (error) {
            console.error('Error updating goal:', error);
            throw error;
        }
    }

    async function createEvent(eventData) {
        try {
            const response = await fetch(`${ API_BASE } /api/events`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            });
            if (!response.ok) throw new Error('Failed to create event');
            return await response.json();
        } catch (error) {
            console.error('Error creating event:', error);
            throw error;
        }
    }

    async function archiveGoalById(goalId) {
        try {
            const response = await fetch(`${ API_BASE } /api/goals / ${ goalId } `, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error('Failed to archive goal');
            return await response.json();
        } catch (error) {
            console.error('Error archiving goal:', error);
            throw error;
        }
    }

    // Import Data functionality
    function showImportDataModal() {
        const modal = document.getElementById('import-data-modal');
        modal.classList.add('active');

        // Reset form and preview
        document.getElementById('import-data-form').reset();
        document.getElementById('file-preview').innerHTML = '<p class="text-muted">No file selected</p>';
        document.getElementById('import-progress').style.display = 'none';

        // Add file change listener
        const fileInput = document.getElementById('data-file');
        fileInput.addEventListener('change', previewFile);
    }

    function previewFile(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('file-preview');

        if (file) {
            const fileSize = (file.size / 1024).toFixed(2); // KB

            preview.innerHTML = `
            < div class="file-info" >
                <div class="file-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                </div>
                <div class="file-details">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize} KB</div>
                </div>
            </div >
            `;
        }
    }

    async function importData(event) {
        event.preventDefault();

        const fileInput = document.getElementById('data-file');
        const file = fileInput.files[0];

        if (!file) {
            alert('Please select a file');
            return;
        }

        // Show progress
        document.getElementById('import-data-form').style.display = 'none';
        document.getElementById('import-progress').style.display = 'block';
        document.getElementById('progress-text').textContent = 'Uploading file...';
        document.getElementById('progress-fill').style.width = '30%';

        try {
            // Create FormData and upload
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(`${ API_BASE } /api/import`, {
                method: 'POST',
                body: formData
            });

            document.getElementById('progress-fill').style.width = '70%';
            document.getElementById('progress-text').textContent = 'Processing data...';

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Upload failed');
            }

            const result = await response.json();

            document.getElementById('progress-fill').style.width = '100%';
            document.getElementById('progress-text').textContent = `Success! Imported ${ result.records_imported || 0 } records`;

            // Wait a bit and close
            setTimeout(() => {
                closeModal('import-data-modal');
                if (currentPage === 'health') {
                    loadHealthMetrics();
                }
                showNotification(`Successfully imported ${ result.records_imported || 0 } health records!`, 'success');
            }, 2000);

        } catch (error) {
            console.error('Error importing data:', error);
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-text').textContent = 'Import failed: ' + error.message;
            document.getElementById('progress-text').style.color = 'var(--error)';

            setTimeout(() => {
                document.getElementById('import-data-form').style.display = 'block';
                document.getElementById('import-progress').style.display = 'none';
                document.getElementById('progress-text').style.color = '';
            }, 3000);
        }
    }
